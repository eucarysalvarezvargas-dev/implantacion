<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Debug Security Questions</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h2 {
            color: #4ec9b0;
        }

        .section {
            background: #252526;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #3c3c3c;
        }

        input,
        button {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #3c3c3c;
            background: #3c3c3c;
            color: #d4d4d4;
        }

        input {
            width: 100%;
            box-sizing: border-box;
        }

        button {
            background: #0e639c;
            color: white;
            cursor: pointer;
            border: none;
            font-weight: bold;
        }

        button:hover {
            background: #1177bb;
        }

        .hash {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            font-size: 12px;
            color: #ce9178;
        }

        .success {
            color: #4ec9b0;
        }

        .error {
            color: #f48771;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        td,
        th {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }

        th {
            background: #1e1e1e;
            color: #4ec9b0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Debug de Preguntas de Seguridad</h1>

        <div class="section">
            <h2>Generador de Hash</h2>
            <p>Ingresa una respuesta para ver c√≥mo se genera el hash:</p>
            <input type="text" id="testAnswer" placeholder="Ejemplo: Hola Mundo" value="">
            <button onclick="generateHash()">Generar Hash</button>

            <div id="hashResults" style="margin-top: 20px;"></div>
        </div>

        <div class="section">
            <h2>Verificar Respuestas Guardadas</h2>
            <p>Email del usuario:</p>
            <input type="email" id="userEmail" placeholder="correo@ejemplo.com">
            <button onclick="checkStoredAnswers()">Verificar Hashes Almacenados</button>

            <div id="storedResults" style="margin-top: 20px;"></div>
        </div>

        <div class="section">
            <h2>Test de Comparaci√≥n</h2>
            <p>Respuesta ingresada:</p>
            <input type="text" id="inputAnswer" placeholder="Respuesta del usuario">
            <p>Hash almacenado en base de datos:</p>
            <input type="text" id="storedHash" placeholder="Hash de la BD">
            <button onclick="compareHash()">Comparar</button>

            <div id="compareResults" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        function generateHash() {
            const answer = document.getElementById('testAnswer').value;
            const resultsDiv = document.getElementById('hashResults');

            if (!answer) {
                resultsDiv.innerHTML = '<p class="error">Por favor ingresa una respuesta</p>';
                return;
            }

            // Simular el proceso de hashing (esto debe coincidir con el backend)
            const trimmed = answer.trim();
            const lowercase = trimmed.toLowerCase();

            const hashTrimmed = md5(md5(trimmed));
            const hashLowercase = md5(md5(lowercase));
            const hashRaw = md5(md5(answer));

            resultsDiv.innerHTML = `
                <table>
                    <tr><th>Formato</th><th>Valor</th><th>Hash MD5(MD5(...))</th></tr>
                    <tr>
                        <td>Original</td>
                        <td>"${answer}"</td>
                        <td class="hash">${hashRaw}</td>
                    </tr>
                    <tr>
                        <td>Trimmed (anterior)</td>
                        <td>"${trimmed}"</td>
                        <td class="hash">${hashTrimmed}</td>
                    </tr>
                    <tr>
                        <td>Lowercase + Trimmed (NUEVO)</td>
                        <td>"${lowercase}"</td>
                        <td class="hash">${hashLowercase}</td>
                    </tr>
                </table>
                <p class="success">‚úì El nuevo formato (lowercase) deber√≠a usarse en registro y actualizaci√≥n de preguntas</p>
            `;
        }

        function compareHash() {
            const input = document.getElementById('inputAnswer').value;
            const stored = document.getElementById('storedHash').value;
            const resultsDiv = document.getElementById('compareResults');

            if (!input || !stored) {
                resultsDiv.innerHTML = '<p class="error">Completa ambos campos</p>';
                return;
            }

            const normalized = input.toLowerCase().trim();
            const trimmed = input.trim();
            const raw = input;

            const hashNormalized = md5(md5(normalized));
            const hashTrimmed = md5(md5(trimmed));
            const hashRaw = md5(md5(raw));

            const matchNormalized = hashNormalized === stored;
            const matchTrimmed = hashTrimmed === stored;
            const matchRaw = hashRaw === stored;

            resultsDiv.innerHTML = `
                <h3>Resultados de Comparaci√≥n:</h3>
                <table>
                    <tr><th>Formato</th><th>Hash Generado</th><th>¬øCoincide?</th></tr>
                    <tr>
                        <td>Normalized (lowercase + trim)</td>
                        <td class="hash">${hashNormalized}</td>
                        <td class="${matchNormalized ? 'success' : 'error'}">${matchNormalized ? '‚úì S√ç' : '‚úó NO'}</td>
                    </tr>
                    <tr>
                        <td>Trimmed only</td>
                        <td class="hash">${hashTrimmed}</td>
                        <td class="${matchTrimmed ? 'success' : 'error'}">${matchTrimmed ? '‚úì S√ç' : '‚úó NO'}</td>
                    </tr>
                    <tr>
                        <td>Raw (sin cambios)</td>
                        <td class="hash">${hashRaw}</td>
                        <td class="${matchRaw ? 'success' : 'error'}">${matchRaw ? '‚úì S√ç' : '‚úó NO'}</td>
                    </tr>
                </table>
                <div style="margin-top: 20px; padding: 15px; background: #1e1e1e; border-radius: 4px;">
                    <strong>Hash almacenado:</strong><br>
                    <span class="hash">${stored}</span>
                </div>
            `;
        }

        async function checkStoredAnswers() {
            const email = document.getElementById('userEmail').value;
            const resultsDiv = document.getElementById('storedResults');

            if (!email) {
                resultsDiv.innerHTML = '<p class="error">Ingresa un email</p>';
                return;
            }

            resultsDiv.innerHTML = '<p>Consultando base de datos...</p>';

            try {
                // Aqu√≠ deber√≠as hacer una petici√≥n al backend
                // Por ahora, mostramos instrucciones
                resultsDiv.innerHTML = `
                    <p class="error">‚ö† Esta funci√≥n requiere un endpoint backend</p>
                    <p>Para verificar manualmente, ejecuta en tinker:</p>
                    <pre style="background: #1e1e1e; padding: 15px; border-radius: 4px; overflow-x: auto;">
$usuario = \\App\\Models\\Usuario::where('correo', '${email}')->first();
if ($usuario) {
    $respuestas = \\App\\Models\\RespuestaSeguridad::where('user_id', $usuario->id)
        ->with('pregunta')->get();
    
    foreach ($respuestas as $r) {
        echo "Pregunta: " . $r->pregunta->pregunta . "\\n";
        echo "Hash: " . $r->respuesta_hash . "\\n\\n";
    }
}
                    </pre>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }

        // Funci√≥n MD5 simple (no para producci√≥n, solo debug)
        function md5(string) {
            // Implementaci√≥n simplificada - usar una librer√≠a real en producci√≥n
            // Por ahora usaremos crypto si est√° disponible
            if (typeof crypto !== 'undefined' && crypto.subtle) {
                // Navegadores modernos
                return crypto.subtle.digest('MD5', new TextEncoder().encode(string))
                    .then(hash => Array.from(new Uint8Array(hash))
                        .map(b => b.toString(16).padStart(2, '0'))
                        .join(''));
            }

            // Fallback: usar una implementaci√≥n JavaScript de MD5
            // Para simplicidad, aqu√≠ deber√≠as incluir una librer√≠a como blueimp-md5
            // Por ahora retornamos un placeholder
            return 'MD5_NOT_AVAILABLE_' + string.length;
        }

        // Cargar librer√≠a MD5 desde CDN
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js';
        script.onload = function () {
            console.log('MD5 library loaded');
            // Reemplazar la funci√≥n md5 placeholder
            window.md5 = window.md5 || function (str) { return window.md5(str); };
        };
        document.head.appendChild(script);
    </script>
</body>

</html>